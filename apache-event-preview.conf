# Apache Virtual Host Configuration for Event Link Previews
# Add this to your Apache virtual host configuration
# Location: /etc/apache2/sites-available/portal.stairs.org.in.conf
# or /etc/httpd/conf.d/portal.stairs.org.in.conf (CentOS/RHEL)
#
# IMPORTANT: Choose ONE of these options:
# Option A: HTTP only (lines 6-69) - Uncomment if NOT using SSL
# Option B: HTTPS with HTTP redirect (lines 71-148) - Use if you have SSL certificate

# ============================================================================
# OPTION A: HTTP Configuration (Uncomment if NOT using SSL)
# ============================================================================
#<VirtualHost *:80>
#    ServerName portal.stairs.org.in
#    ServerAlias www.portal.stairs.org.in
#    
#    # Document root for frontend
#    DocumentRoot /var/www/stairs-new/frontend/dist
#    
#    <Directory /var/www/stairs-new/frontend/dist>
#        Options -Indexes +FollowSymLinks
#        AllowOverride All
#        Require all granted
#        
#        # Enable rewrite engine
#        RewriteEngine On
#        
#        # Bot detection for event pages - MUST BE BEFORE React routing
#        # Proxy bot requests directly to backend preview endpoint
#        # Note: [P] flag requires mod_proxy and mod_proxy_http to be enabled
#        RewriteCond %{HTTP_USER_AGENT} (bot|crawler|spider|scraper|facebookexternalhit|facebookcatalog|Twitterbot|Twitter|LinkedInBot|LinkedIn|WhatsApp|whatsapp|Slackbot|Slack|TelegramBot|Telegram|SkypeUriPreview|Discordbot|Discord|Googlebot|Google|Bingbot|Bing|Slurp|DuckDuckBot|Baiduspider|YandexBot|Sogou|Exabot|facebot|ia_archiver|Pinterestbot|Pinterest|redditbot|reddit|Applebot|Line|Kik|Viber|WeChat|Snapchat|TikTok|PostmanRuntime|curl|wget) [NC]
#        RewriteRule ^event/([^/]+)$ http://localhost:5000/api/events/preview/$1 [P,L]
#        
#        # Standard React SPA routing (for non-bots)
#        RewriteCond %{REQUEST_FILENAME} !-f
#        RewriteCond %{REQUEST_FILENAME} !-d
#        RewriteRule . /index.html [L]
#    </Directory>
#    
#    # Backend API proxy
#    ProxyPreserveHost On
#    ProxyRequests Off
#    
#    <Location /api>
#        ProxyPass http://localhost:5000/api
#        ProxyPassReverse http://localhost:5000/api
#        ProxyPreserveHost On
#        
#        # Headers for proxy
#        RequestHeader set X-Forwarded-Proto "http"
#        RequestHeader set X-Real-IP %{REMOTE_ADDR}s
#    </Location>
#    
#    # Logo and static assets
#    <LocationMatch "\.(png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
#        ExpiresActive On
#        ExpiresDefault "access plus 30 days"
#        Header set Cache-Control "public, immutable"
#    </LocationMatch>
#    
#    # Uploads directory
#    Alias /uploads /var/www/stairs-new/backend/uploads
#    <Directory /var/www/stairs-new/backend/uploads>
#        Options -Indexes
#        Require all granted
#        ExpiresActive On
#        ExpiresDefault "access plus 30 days"
#    </Directory>
#    
#    # Logging
#    ErrorLog ${APACHE_LOG_DIR}/portal.stairs.org.in-error.log
#    CustomLog ${APACHE_LOG_DIR}/portal.stairs.org.in-access.log combined
#    
#    # Max upload size
#    LimitRequestBody 52428800
#</VirtualHost>

# ============================================================================
# OPTION B: HTTPS Configuration with HTTP Redirect (Recommended for Production)
# ============================================================================

# HTTPS Virtual Host
<VirtualHost *:443>
    ServerName portal.stairs.org.in
    ServerAlias www.portal.stairs.org.in
    
    # SSL Configuration - Update paths to your SSL certificates
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/portal.stairs.org.in/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/portal.stairs.org.in/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf
    
    # Document root for frontend
    DocumentRoot /var/www/stairs-new/frontend/dist
    
    <Directory /var/www/stairs-new/frontend/dist>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Enable rewrite engine
        RewriteEngine On
        
        # Bot detection for event pages - MUST BE BEFORE React routing
        # Proxy bot requests directly to backend preview endpoint
        # Note: [P] flag requires mod_proxy and mod_proxy_http to be enabled
        RewriteCond %{HTTP_USER_AGENT} (bot|crawler|spider|scraper|facebookexternalhit|facebookcatalog|Twitterbot|Twitter|LinkedInBot|LinkedIn|WhatsApp|whatsapp|Slackbot|Slack|TelegramBot|Telegram|SkypeUriPreview|Discordbot|Discord|Googlebot|Google|Bingbot|Bing|Slurp|DuckDuckBot|Baiduspider|YandexBot|Sogou|Exabot|facebot|ia_archiver|Pinterestbot|Pinterest|redditbot|reddit|Applebot|Line|Kik|Viber|WeChat|Snapchat|TikTok|PostmanRuntime|curl|wget) [NC]
        RewriteRule ^event/([^/]+)$ http://localhost:5000/api/events/preview/$1 [P,L]
        
        # Standard React SPA routing (for non-bots)
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>
    
    # Backend API proxy
    ProxyPreserveHost On
    ProxyRequests Off
    
    <Location /api>
        ProxyPass http://localhost:5000/api
        ProxyPassReverse http://localhost:5000/api
        ProxyPreserveHost On
        
        # Headers for proxy
        RequestHeader set X-Forwarded-Proto "https"
        RequestHeader set X-Real-IP %{REMOTE_ADDR}s
    </Location>
    
    # Logo and static assets
    <LocationMatch "\.(png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        ExpiresActive On
        ExpiresDefault "access plus 30 days"
        Header set Cache-Control "public, immutable"
    </LocationMatch>
    
    # Uploads directory
    Alias /uploads /var/www/stairs-new/backend/uploads
    <Directory /var/www/stairs-new/backend/uploads>
        Options -Indexes
        Require all granted
        ExpiresActive On
        ExpiresDefault "access plus 30 days"
    </Directory>
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/portal.stairs.org.in-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/portal.stairs.org.in-ssl-access.log combined
    
    # Max upload size
    LimitRequestBody 52428800
</VirtualHost>

# HTTP to HTTPS Redirect (Only needed if using HTTPS)
<VirtualHost *:80>
    ServerName portal.stairs.org.in
    ServerAlias www.portal.stairs.org.in
    Redirect permanent / https://portal.stairs.org.in/
</VirtualHost>
