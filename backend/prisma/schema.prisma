// Prisma schema file for STAIRS Talent Hub

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = "postgresql://neondb_owner:npg_lCO1hsqYHXn3@ep-aged-hat-ad5gla06-pooler.c-2.us-east-1.aws.neon.tech/neondb?sslmode=require"
}

model User {
  id              String        @id @default(cuid())
  email           String?       @unique
  phone           String?       @unique
  password        String?
  role            UserRole      @default(STUDENT)
  name            String?
  isActive        Boolean       @default(true)
  isVerified      Boolean       @default(false)
  uniqueId        String?       @unique @map("unique_id")
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  adminProfile    Admin?
  studentProfile  Student?
  coachProfile    Coach?
  instituteProfile Institute?
  clubProfile     Club?
  notifications   Notification[]
  otpRecords      OTPRecord[]
  payments        Payment[]
  eventAssignments EventAssignment[]

  @@map("users")
}

model OTPRecord {
  id        String   @id @default(cuid())
  userId    String
  code      String
  type      OTPType
  expiresAt DateTime
  isUsed    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("otp_records")
}

model Student {
  id                 String                   @id @default(cuid())
  userId             String                   @unique
  name               String
  fatherName         String?
  aadhaar            String?                  @unique
  gender             String?
  dateOfBirth        DateTime?
  state              String?
  district           String?
  address            String?
  pincode            String?
  sport              String?
  sport2             String?
  sport3             String?
  level              String?
  school             String?
  club               String?
  coachName          String?
  coachMobile        String?
  achievements       String?
  profileCompletion  Int                      @default(0)
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  clubMembers        ClubMember[]
  eventRegistrations EventRegistration[]
  instituteStudents  InstituteStudent[]
  coachConnections   StudentCoachConnection[]
  registrationItems  EventRegistrationOrderItem[]
  user               User                     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("students")
}

model Coach {
  id                    String                   @id @default(cuid())
  userId                String                   @unique
  name                  String
  fatherName            String?
  motherName            String?
  aadhaar               String?                  @unique
  gender                String?
  dateOfBirth           DateTime?
  state                 String?
  district              String?
  address               String?
  pincode               String?
  panNumber             String?                  @unique
  utrNumber             String?
  membershipStatus      String?                  @default("NEW")
  applyingAs            String?                  @default("Chief District coordinator")
  primarySport          String?
  otherSports           String?
  specialization        String?
  experience            Int?
  certifications        String?
  bio                   String?
  location              String?
  city                  String?
  paymentStatus         PaymentStatus            @default(PENDING)
  subscriptionType      SubscriptionType?
  subscriptionExpiresAt DateTime?
  isActive              Boolean                  @default(false)
  rating                Float?                   @default(0)
  totalStudents         Int                      @default(0)
  createdAt             DateTime                 @default(now())
  updatedAt             DateTime                 @updatedAt
  user                  User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  eventOrders           EventOrder[]
  eventResultFiles      EventResultFile[]
  events                Event[]
  instituteCoaches      InstituteCoach[]
  studentConnections    StudentCoachConnection[]
  registrationOrders    EventRegistrationOrder[]

  @@map("coaches")
}

model Institute {
  id            String             @id @default(cuid())
  userId        String             @unique
  name          String
  type          String?
  location      String?
  city          String?
  state         String?
  pincode       String?
  established   String?
  sportsOffered String?
  studentsCount Int                @default(0)
  coachesCount  Int                @default(0)
  paymentStatus PaymentStatus      @default(PENDING)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  coaches       InstituteCoach[]
  students      InstituteStudent[]
  user          User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("institutes")
}

model Club {
  id              String        @id @default(cuid())
  userId          String        @unique
  name            String
  type            String?
  location        String?
  city            String?
  state           String?
  established     String?
  facilities      String?
  membershipTypes String?
  membersCount    Int           @default(0)
  paymentStatus   PaymentStatus @default(PENDING)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  members         ClubMember[]
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("clubs")
}

model Admin {
  id              String       @id @default(cuid())
  userId          String       @unique
  name            String
  role            AdminRole    @default(ADMIN)
  permissions     String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  processedOrders EventOrder[]

  @@map("admins")
}

model StudentCoachConnection {
  id          String           @id @default(cuid())
  studentId   String
  coachId     String
  status      ConnectionStatus @default(PENDING)
  initiatedBy InitiatedBy
  message     String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  coach       Coach            @relation(fields: [coachId], references: [id], onDelete: Cascade)
  student     Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, coachId])
  @@map("student_coach_connections")
}

model InstituteStudent {
  id          String    @id @default(cuid())
  instituteId String
  studentId   String
  createdAt   DateTime  @default(now())
  institute   Institute @relation(fields: [instituteId], references: [id], onDelete: Cascade)
  student     Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([instituteId, studentId])
  @@map("institute_students")
}

model InstituteCoach {
  id          String    @id @default(cuid())
  instituteId String
  coachId     String
  createdAt   DateTime  @default(now())
  coach       Coach     @relation(fields: [coachId], references: [id], onDelete: Cascade)
  institute   Institute @relation(fields: [instituteId], references: [id], onDelete: Cascade)

  @@unique([instituteId, coachId])
  @@map("institute_coaches")
}

model ClubMember {
  id             String       @id @default(cuid())
  clubId         String
  studentId      String
  membershipType String?
  status         MemberStatus @default(ACTIVE)
  joinedAt       DateTime     @default(now())
  club           Club         @relation(fields: [clubId], references: [id], onDelete: Cascade)
  student        Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([clubId, studentId])
  @@map("club_members")
}

model Event {
  id                  String              @id @default(cuid())
  name                String
  description         String?
  sport               String
  venue               String
  address             String?
  city                String
  state               String
  latitude            Float?
  longitude           Float?
  startDate           DateTime
  endDate             DateTime?
  maxParticipants     Int                 @default(50)
  currentParticipants Int                 @default(0)
  eventFee            Float               @default(0)
  coordinatorFee      Float               @default(0)
  eventCategory       String?             // optional custom category for fee calc
  feeMode             EventFeeMode        @default(GLOBAL)
  level               EventLevel          @default(DISTRICT)
  status              EventStatus         @default(PENDING)
  adminNotes          String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  coachId             String
  /// Custom UID for event in format: <serial>-<sportCode>-EVT-<locationCode>-<MMYYYY>
  uniqueId            String?             @unique @map("unique_id") @db.VarChar(255)
  orders              EventOrder[]
  payments            EventPayment[]
  registrations       EventRegistration[]
  resultFiles         EventResultFile[]
  registrationOrders  EventRegistrationOrder[]
  registrationItems   EventRegistrationOrderItem[]
  assignments         EventAssignment[]
  permissions         EventPermission[]
  coach               Coach               @relation(fields: [coachId], references: [id], onDelete: Cascade)

  @@map("events")
}

// Global payment settings (single-row table; use the first record)
model GlobalSettings {
  id                     String   @id @default(cuid())
  perStudentBaseCharge   Float    @default(0)   // global per-student base charge
  defaultEventFee        Float    @default(0)   // default fee when feeMode=GLOBAL and event fee not set
  coordinatorSubscriptionFee Float @default(0)  // coordinator subscription fee (one-time registration fee)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@map("global_settings")
}

model EventAssignment {
  id        String                @id @default(cuid())
  eventId   String
  userId    String
  role      EventAssignmentRole
  createdAt DateTime              @default(now())
  event     Event                 @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user      User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId, role])
  @@map("event_assignments")
}

model EventPermission {
  id                   String                @id @default(cuid())
  eventId              String
  role                 EventAssignmentRole
  resultUpload         Boolean               @default(false)
  studentManagement    Boolean               @default(false)
  certificateManagement Boolean              @default(false)
  feeManagement        Boolean               @default(false)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  event                Event                 @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, role])
  @@map("event_permissions")
}

model EventRegistration {
  id        String             @id @default(cuid())
  eventId   String
  studentId String
  status    RegistrationStatus @default(PENDING)
  message   String?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  event     Event              @relation(fields: [eventId], references: [id], onDelete: Cascade)
  student   Student            @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([eventId, studentId])
  @@map("event_registrations")
}

model Payment {
  id                String    @id(map: "new_payments_pkey") @default(cuid())
  userId            String?
  userType          String?
  coachId           String?
  type              String
  amount            Float     @db.Real
  currency          String    @default("INR")
  razorpayOrderId   String?
  razorpayPaymentId String?
  status            String    @default("PENDING")
  description       String?
  metadata          String?
  expiresAt         DateTime? @db.Timestamp(6)
  createdAt         DateTime  @default(now()) @db.Timestamp(6)
  updatedAt         DateTime  @updatedAt @db.Timestamp(6)
  user              User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model EventPayment {
  id                String        @id @default(cuid())
  eventId           String
  amount            Float
  currency          String        @default("INR")
  razorpayOrderId   String?
  razorpayPaymentId String?
  status            PaymentStatus @default(PENDING)
  description       String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  event             Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("event_payments")
}

model EventResultFile {
  id           String   @id @default(cuid())
  filename     String
  originalName String
  mimeType     String
  size         Int
  uploadedAt   DateTime @default(now())
  eventId      String
  coachId      String
  description  String?
  coach        Coach    @relation(fields: [coachId], references: [id], onDelete: Cascade)
  event        Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("event_result_files")
}

model Certificate {
  id              String   @id @default(cuid())
  studentId       String
  eventId         String
  orderId         String?
  certificateUrl  String
  participantName String
  sportName       String
  eventName       String
  issueDate       DateTime @default(now())
  /// Custom UID format: STAIRS-CERT-<EventUID>-<StudentUID>
  uniqueId        String   @unique @map("uid")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([studentId, eventId])
  @@unique([studentId, eventId, orderId])
  @@map("certificates")
}

model EventOrder {
  id                  String        @id @default(cuid())
  orderNumber         String        @unique
  certificates        Int           @default(0)
  medals              Int           @default(0)
  trophies            Int           @default(0)
  specialInstructions String?
  urgentDelivery      Boolean       @default(false)
  certificatePrice    Float?
  medalPrice          Float?
  trophyPrice         Float?
  totalAmount         Float?
  status              OrderStatus   @default(PENDING)
  adminRemarks        String?
  paymentStatus       PaymentStatus @default(PENDING)
  razorpayOrderId     String?
  razorpayPaymentId   String?
  paymentDate         DateTime?
  paymentMethod       String?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  processedAt         DateTime?
  completedAt         DateTime?
  eventId             String
  coachId             String
  processedBy         String?
  coach               Coach         @relation(fields: [coachId], references: [id], onDelete: Cascade)
  event               Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  admin               Admin?        @relation(fields: [processedBy], references: [id])

  @@map("event_orders")
}

// Bulk Student Registration for events with fee tracking
model EventRegistrationOrder {
  id                    String                      @id @default(cuid())
  orderNumber           String                      @unique
  eventId               String
  coachId               String
  eventFeePerStudent    Float                       @default(0) // e.g., â‚¹500 per student
  totalStudents         Int                         @default(0)
  totalFeeAmount        Float                       @default(0) // e.g., 50 * 500 = 25000
  status                OrderStatus                 @default(PENDING) // PENDING, PAYMENT_PENDING, PAID, COMPLETED
  paymentStatus         PaymentStatus               @default(PENDING) // PENDING, PAID
  razorpayOrderId       String?
  razorpayPaymentId     String?
  paymentDate           DateTime?
  paymentMethod         String?
  certificateGenerated  Boolean                     @default(false)
  adminNotified         Boolean                     @default(false) // Notified for final payment & certs
  adminNotes            String?
  createdAt             DateTime                    @default(now())
  updatedAt             DateTime                    @updatedAt
  completedAt           DateTime?
  coach                 Coach                       @relation(fields: [coachId], references: [id], onDelete: Cascade)
  event                 Event                       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  registrationItems     EventRegistrationOrderItem[]

  @@unique([eventId, coachId])
  @@map("event_registration_orders")
}

// Individual student registrations within a bulk order
model EventRegistrationOrderItem {
  id                      String                   @id @default(cuid())
  registrationOrderId     String
  eventId                 String
  studentId              String
  status                  RegistrationStatus      @default(REGISTERED) // REGISTERED, APPROVED, REJECTED
  certificateId           String?
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt
  registrationOrder       EventRegistrationOrder  @relation(fields: [registrationOrderId], references: [id], onDelete: Cascade)
  event                   Event                   @relation(fields: [eventId], references: [id])
  student                 Student                 @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([registrationOrderId, studentId])
  @@map("event_registration_order_items")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      String?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  readAt    DateTime?
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

enum UserRole {
  STUDENT
  COACH
  INSTITUTE
  CLUB
  ADMIN
  EVENT_INCHARGE
}

enum OTPType {
  REGISTRATION
  LOGIN
  PASSWORD_RESET
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum PaymentType {
  REGISTRATION
  SUBSCRIPTION_MONTHLY
  SUBSCRIPTION_ANNUAL
  EVENT_FEE
  SUBSCRIPTION
}

enum SubscriptionType {
  MONTHLY
  ANNUAL
}

enum ConnectionStatus {
  PENDING
  ACCEPTED
  REJECTED
  BLOCKED
}

enum InitiatedBy {
  STUDENT
  COACH
  INSTITUTE
  CLUB
}

enum EventStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
  ACTIVE
  CANCELLED
  COMPLETED
  RESULTS_UPLOADED
  RESULTS_VALIDATED
  FINAL_PAYMENT_COMPLETED
  CERTIFICATES_ISSUED
  READY_FOR_NEXT_REGISTRATION
}

enum EventLevel {
  DISTRICT
  STATE
  NATIONAL
  SCHOOL
}

enum EventFeeMode {
  GLOBAL
  EVENT
  DISABLED
}

enum RegistrationStatus {
  PENDING
  REGISTERED
  APPROVED
  REJECTED
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  AUTHORIZER
  VIEWER
}

enum MemberStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PAYMENT_PENDING
  PAID
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum NotificationType {
  EVENT_APPROVED
  EVENT_REJECTED
  EVENT_SUSPENDED
  EVENT_RESTARTED
  ORDER_CONFIRMED
  ORDER_IN_PROGRESS
  ORDER_COMPLETED
  ORDER_CANCELLED
  PAYMENT_RECEIVED
  PAYMENT_FAILED
  GENERAL
}

enum EventAssignmentRole {
  INCHARGE
  COORDINATOR
  TEAM
}
